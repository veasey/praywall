{% extends "base.twig" %}

{% block content %}
    
  <h1>Prayers</h1>

  {% for prayer in prayers %}
    <div class="prayer-card" id="prayer-{{ prayer.id }}">

      {% if user and user.role != 'user' %}
        <div class="unapprove-button">
          <a href="/moderate/unapprove/{{prayer.id}}">Unapprove</a>
        </div>
      {% endif %}

      <h2>{{ prayer.title }}</h2>
      <p>{{ prayer.body }}</p>

      <div class="prayer-card-footer">
        {% set prayUrl = "/prayers/pray/" ~ prayer.id ~ "?page=" ~ currentPage ~ "&limit=" ~ (limit|default(10)) ~ "#prayer-" ~ prayer.id %}
        <form method="post" action="{{ prayUrl }}" class="pray-form">
          <button 
            type="submit" 
            class="pray-button {% if prayer.has_prayed %}prayed{% else %}not-prayed{% endif %}"
          >
            🙏 
            {% if prayer.has_prayed %}
              You prayed ({{ prayer.prayed_count }})
            {% else %}
              Pray ({{ prayer.prayed_count > 0 ? prayer.prayed_count : '0' }})
            {% endif %}
          </button>
        </form>

        <p class="date">
          {{ prayer.date_posted|date("F jS \\a\\t g:ia")  }}
        </p>
      </div>

    </div>
  {% else %}
    <p>No prayers yet.</p>
  {% endfor %}

  {% if totalPages > 1 %}
    <nav class="pagination-controls">
      {% if currentPage > 1 %}
        <a href="?page={{ currentPage - 1 }}&order={{ order|default('desc') }}&limit={{ limit|default(10) }}">&laquo; Previous</a>
      {% endif %}

      <span>Page {{ currentPage }} of {{ totalPages }}</span>

      {% if currentPage < totalPages %}
        <a href="?page={{ currentPage + 1 }}&order={{ order|default('desc') }}&limit={{ limit|default(10) }}">Next &raquo;</a>
      {% endif %}
    </nav>
  {% endif %}

  <form method="get" class="pagination-options">
    <label for="order">Sort:</label>
    <select name="order" id="order" onchange="this.form.submit()">
      <option value="desc" {{ order == 'desc' ? 'selected' : '' }}>Newest first</option>
      <option value="asc" {{ order == 'asc' ? 'selected' : '' }}>Oldest first</option>
    </select>

    <label for="limit">Show:</label>
    <select name="limit" id="limit" onchange="this.form.submit()">
      <option value="5" {{ limit == 5 ? 'selected' : '' }}>5</option>
      <option value="10" {{ limit == 10 ? 'selected' : '' }}>10</option>
      <option value="20" {{ limit == 20 ? 'selected' : '' }}>20</option>
    </select>
  </form>

  <!-- Button to submit a new prayer -->
  <div>
    <a href="/prayers/request">
      <button type="button">Submit a Request for Prayer</button>
    </a>
  </div>

{% endblock %}